# Cross-Chain ICO System

## üéØ Overview

This is a **cross-chain ICO system** that combines **private bidding** on Oasis Sapphire with **atomic settlement** on Ethereum. The system provides:

- ‚úÖ **Private bidding** with encrypted bids on Sapphire
- ‚úÖ **Atomic settlement** with batch processing on Ethereum  
- ‚úÖ **60-70% gas savings** compared to individual settlements
- ‚úÖ **Fault-tolerant** design with graceful failure handling
- ‚úÖ **TEE-verified** results with cryptographic proofs

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          CROSS-CHAIN ICO SYSTEM                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ    ETHEREUM         ‚îÇ         ‚îÇ     SAPPHIRE        ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ   (Settlement)      ‚îÇ         ‚îÇ   (Private Bids)    ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ                     ‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ KITTY Token   ‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ ICO Contract  ‚îÇ  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ (ERC20)       ‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ (Confidential)‚îÇ  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ         ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ                     ‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îÇBatchSettlement‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ  Encrypted    ‚îÇ  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ (Atomic)      ‚îÇ  ‚îÇ         ‚îÇ  ‚îÇ  Bid Storage  ‚îÇ  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ         ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                             ‚îÇ
‚îÇ                    ‚îÇ   TEE AGENT (ROLF)  ‚îÇ                             ‚îÇ
‚îÇ                    ‚îÇ                     ‚îÇ                             ‚îÇ
‚îÇ                    ‚îÇ  ‚Ä¢ Monitors Events  ‚îÇ                             ‚îÇ
‚îÇ                    ‚îÇ  ‚Ä¢ Processes Bids   ‚îÇ                             ‚îÇ
‚îÇ                    ‚îÇ  ‚Ä¢ Executes Batch   ‚îÇ                             ‚îÇ
‚îÇ                    ‚îÇ  ‚Ä¢ Signs Results    ‚îÇ                             ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã Contract Addresses

| Contract | Network | Purpose |
|----------|---------|---------|
| **KITTY Token** | Ethereum | ERC20 token being sold |
| **BatchSettlement** | Ethereum | Atomic settlement execution |
| **ICO Contract** | Sapphire | Private bidding & TEE coordination |

## üîÑ Complete Flow

### 1. **Setup Phase**
```bash
# Deploy on Ethereum
npx hardhat run deploy/00_deploy.ts --network sepolia

# Deploy on Sapphire  
TOKEN_CONTRACT_ADDRESS=0x... BATCH_SETTLEMENT_ADDR=0x... \
npx hardhat run deploy/00_deploy.ts --network sapphire-testnet
```

### 2. **Sale Creation**
```solidity
// Issuer approves BatchSettlement to spend tokens
kittyToken.approve(batchSettlementAddress, saleSupply);

// Create sale on Sapphire
icoContract.createSale(supply, deadline, policyHash);
```

### 3. **Bidding Phase**
```solidity
// Bidders encrypt their bids with TEE public key
{
  price: "1000000000000000000",      // 1 USDC per token
  quantity: "50000000000000000000",  // 50 tokens
  pitch: "Strategic partnership...",
  country: "US"
}

// Submit encrypted bid with USDC permit
icoContract.submitBid(saleId, encryptedBid, maxSpend, permitSignature);
```

### 4. **TEE Processing**
```typescript
// TEE Agent monitors Sapphire events
icoContract.on('SettlementRecorded', async (saleId, totalWinners, totalTokens) => {
  // Process settlement
  const settlements = await collectSettlements(saleId);
  const signature = await signWithTEE(settlements);
  
  // Execute batch settlement on Ethereum
  await batchSettlement.batchSettle({
    saleId,
    issuer,
    tokenAddress: KITTY_TOKEN,
    paymentToken: USDC,
    settlements,
    teeSignature: signature
  });
});
```

### 5. **Atomic Settlement**
```solidity
// BatchSettlement executes atomically:
// 1. Verify TEE signature
// 2. For each winner:
//    - Execute permit() to authorize payment
//    - Transfer USDC from winner to issuer
//    - Transfer KITTY tokens from issuer to winner
// 3. Emit settlement events
```

## üìä Gas Efficiency

| Method | Gas Cost | USD Cost* |
|--------|----------|-----------|
| **Individual Settlements** | ~8.6M gas | $200-500 |
| **Batch Settlement** | ~3.0M gas | $70-150 |
| **Savings** | **60-70%** | **$130-350** |

*_Based on 100 winners, gas price varies with network congestion_

## üîê Security Features

### **TEE Verification**
- All settlement results are signed by the TEE agent
- Cryptographic proof ensures integrity
- Public verification on-chain

### **Fault Tolerance**
- Failed permits don't break entire batch
- Detailed failure events for debugging
- Graceful partial completion

### **Privacy**
- Bid details remain confidential on Sapphire
- Only final allocations are public
- No bid information leakage

## üöÄ Deployment Guide

### **Prerequisites**
```bash
# Install dependencies
cd backend && pnpm install

# Set environment variables
export TEE_PRIVATE_KEY=0x...
export ETHEREUM_SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/...
```

### **Step 1: Deploy on Ethereum**
```bash
npx hardhat run deploy/00_deploy.ts --network sepolia
```

**Output:**
```
‚úÖ KITTY Token deployed: 0x1234...
‚úÖ BatchSettlement deployed: 0x5678...

export TOKEN_CONTRACT_ADDRESS=0x1234...
export BATCH_SETTLEMENT_ADDR=0x5678...
```

### **Step 2: Deploy on Sapphire**
```bash
TOKEN_CONTRACT_ADDRESS=0x1234... BATCH_SETTLEMENT_ADDR=0x5678... \
npx hardhat run deploy/00_deploy.ts --network sapphire-testnet
```

**Output:**
```
‚úÖ ICO Contract deployed: 0x9abc...

export ICO_ADDR=0x9abc...
```

### **Step 3: Start TEE Agent**
```bash
# Set additional environment variables
export ICO_ADDR=0x9abc...
export PAYMENT_TOKEN_ADDRESS=0x... # USDC address

# Run TEE agent
npx ts-node src/tee-agent-example.ts
```

## üß™ Testing

### **Unit Tests**
```bash
npx hardhat test
```

### **Integration Tests**
```bash
# Test cross-chain flow
npx hardhat test test/CrossChainICO.ts
```

### **Local Development**
```bash
# Start local Sapphire node
docker run -it -p8545:8545 ghcr.io/oasisprotocol/sapphire-localnet

# Deploy to local networks
npx hardhat run deploy/00_deploy.ts --network localhost
npx hardhat run deploy/00_deploy.ts --network sapphire-localnet
```

## üìö API Reference

### **ICO Contract (Sapphire)**
```solidity
// Create a new sale
function createSale(uint256 supply, uint256 deadline, bytes policyHash) 
  returns (uint256 saleId)

// Submit encrypted bid
function submitBid(uint256 saleId, bytes encBlob, uint256 maxSpend, bytes permitSig)

// Finalize sale (TEE only)
function finalize(uint256 saleId, bytes result, bytes teeSig)
```

### **BatchSettlement (Ethereum)**
```solidity
// Execute atomic settlement
function batchSettle(BatchSettleParams params)

struct BatchSettleParams {
  uint256 saleId;
  address issuer;
  address tokenAddress;
  address paymentToken;
  SettlementData[] settlements;
  bytes teeSignature;
}
```

## üîß Configuration

### **Supported Payment Tokens**
- **USDC** (Recommended) - Full EIP-2612 support
- **WETH** - Requires ETH wrapping
- **USDT** - Higher gas costs, limited permit support

### **Network Configuration**
```typescript
// Ethereum Networks
sepolia: {
  chainId: 11155111,
  url: 'https://sepolia.infura.io/v3/...'
}

// Sapphire Networks
'sapphire-testnet': {
  chainId: 0x5aff,
  url: 'https://testnet.sapphire.oasis.io'
}
```

## üéØ Benefits

### **For Issuers**
- ‚úÖ Choose strategic backers, not just highest bidders
- ‚úÖ Automated settlement with minimal gas costs
- ‚úÖ Transparent and auditable process

### **For Bidders**
- ‚úÖ Private bidding prevents front-running
- ‚úÖ Fair allocation based on multiple criteria
- ‚úÖ Atomic settlement guarantees

### **For Developers**
- ‚úÖ Modular, extensible architecture
- ‚úÖ Clear separation of concerns
- ‚úÖ Comprehensive testing framework

## üî¨ Advanced Features

### **Scoring Algorithm**
```javascript
score = 0.6 √ó price + 0.2 √ó geoBonus + 0.2 √ó pitchScore
```

### **Bid Encryption**
```javascript
// HPKE encryption with TEE public key
const encryptedBid = await hpke.encrypt(teePubKey, JSON.stringify({
  price: "1000000000000000000",
  quantity: "50000000000000000000", 
  pitch: "Strategic partnership proposal...",
  country: "US"
}));
```

### **Permit Signatures**
```javascript
// EIP-2612 permit for gasless approvals
const permit = await signPermit(
  usdc,
  owner,
  spender,
  value,
  deadline,
  privateKey
);
```

## üìû Support

- üìß **Issues**: GitHub Issues
- üìñ **Documentation**: `/docs` directory
- üí¨ **Community**: Discord/Telegram
- üêõ **Bug Reports**: Security contact

---

Built with ‚ù§Ô∏è for the Oasis ecosystem 